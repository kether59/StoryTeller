# ================================
# Stage 1: Builder
# ================================
FROM python:3.13-slim as builder
WORKDIR /app

RUN apt-get update && apt-get install -y \
    gcc g++ build-essential && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .

RUN pip install --no-cache-dir --prefix=/install -r requirements.txt

RUN python -m spacy download fr_core_news_md --prefix=/install || echo "spaCy model download skipped" [cite: 3]

# ================================
# Stage 2: Runtime
# ================================
FROM python:3.13-slim

# 1. Create user first
RUN useradd -m -u 1000 appuser

# 2. Set WORKDIR to root to allow 'backend' to be a package
WORKDIR /

# 3. Copy dependencies
COPY --from=builder /install /usr/local

# 4. Copy the app into the /backend folder
COPY --chown=appuser:appuser . /backend

# 5. Create the data directory inside the package folder
RUN mkdir -p /backend/data && chown -R appuser:appuser /backend

# 6. Set environment variables
ENV PYTHONPATH=/
ENV PYTHONUNBUFFERED=1
USER appuser

# 7. Use the package-style entrypoint
ENTRYPOINT ["/bin/sh", "/backend/docker-entrypoint.sh"]